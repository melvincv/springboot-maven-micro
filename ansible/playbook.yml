---
- name: deploy to CD server
  hosts: web
  become: true
  vars:
    DOCKER_REGISTRY: 221968583774.dkr.ecr.ap-northeast-1.amazonaws.com
    DOCKER_IMAGE: springbootapp
  tasks:
  # AWS ECR Actions
    - name: Establish login to ECR
      shell: aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin {{ DOCKER_REGISTRY }}
    - name: Pull image from ECR
      docker_image:
        name: {{ DOCKER_REGISTRY }}/{{ DOCKER_IMAGE }}:"{{ BUILD_NUMBER }}"
        source: pull
    - name: Run container
      docker_container:
        name: web
        image: {{ DOCKER_REGISTRY }}/{{ DOCKER_IMAGE }}:"{{ BUILD_NUMBER }}"
        exposed_ports:
          - 8080
        state: present
        recreate: yes
        restart_policy: unless-stopped